<div x-data="aiChat(<?php echo (int)$block->getCurrentProductId(); ?>)">
  <style>
 
    .ai-chat-container{
      position:fixed;bottom:20px;right:20px;width:380px;height:500px;
      background:#fff;border-radius:12px;box-shadow:0 8px 40px rgba(0,0,0,.15);
      z-index:9999;display:flex;flex-direction:column;overflow:hidden;
      font-family:system-ui,Segoe UI,Roboto;
    }
    .ai-chat-header{
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#fff;padding:12px;display:flex;justify-content:space-between;
      align-items:center;font-weight:600;
    }
    .ai-chat-messages{
      flex:1;overflow-y:auto;padding:15px;background:#f8f9fa;
      display:flex;flex-direction:column;gap:12px;
      scroll-behavior: smooth;
    }
    .ai-message{
      padding:10px 14px;border-radius:18px;max-width:85%;line-height:1.4;
      font-size:14px;
    }
    .ai-message.user{
      background:#667eea;color:#fff;align-self:flex-end;
      border-bottom-right-radius: 4px;
    }
    .ai-message.ai{
      background:#fff;color:#333;align-self:flex-start;
      border: 1px solid #e9ecef;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      border-bottom-left-radius: 4px;
    }
    .ai-message.error{
      background:#f8d7da;color:#721c24;align-self:center;
      border:none;border-radius:8px;
    }
    .ai-message.loading{
      background:#e9ecef;color:#6c757d;align-self:flex-start;
      padding:10px 14px;
    }
    .ai-chat-input-area{
      padding:10px;border-top:1px solid #e6e6e6;
      display:flex;align-items:center;gap:8px;background:#fff;
    }
    .ai-chat-input{
      flex:1;padding:10px;border-radius:8px;border:1px solid #ddd;
      resize:none;font-size:14px;max-height:80px;
    }
    .ai-chat-send{
      background:#667eea;color:#fff;border:none;width:40px;height:40px;
      border-radius:8px;cursor:pointer;display:flex;justify-content:center;
      align-items:center;transition: background 0.2s;
    }
    .ai-chat-send:disabled{ background:#ccc;cursor:not-allowed; }
    .ai-spinner{
      width:16px;height:16px;border:3px solid rgba(255,255,255,0.3);
      border-top:3px solid #fff;border-radius:50%;animation:spin 1s linear infinite;
    }
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    [x-cloak] { display: none !important; }
    .ai-send-icon::before {
        content: 'â–²';
        transform: rotate(45deg);
        display:block;font-size:16px;
        margin-left: 2px;margin-top: -2px;
    }

    .ai-chat-toggle {
        position: fixed; 
        bottom: 20px; 
        right: 20px; 
        width: 70px; 
        height: 70px; 
        border-radius: 50%; 
        background: #000000;
        border: none; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.4); 
        cursor: pointer; 
        z-index: 10000; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        padding: 0;
    }
  </style>

  <button 
    class="ai-chat-toggle"
    @click="toggleChat()"
    x-show="!chatOpen" 
  >
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
  </button>


  <div class="ai-chat-container" x-show="chatOpen">
    <div class="ai-chat-header">
      <div>ðŸ¤– AI Product Assistant</div>
      <button @click="toggleChat()" style="background:transparent;border:none;color:#fff;font-size:20px;cursor:pointer;">
          &times;
      </button>
    </div>

    <div class="ai-chat-messages" x-ref="messagesContainer">
      <template x-for="(m,i) in messages" :key="i">
         <div :class="`ai-message ${m.type}`" x-html="m.content"></div>
      </template>
  </div>

    <div class="ai-chat-input-area">
      <textarea class="ai-chat-input" rows="1" x-model="question"
        @keydown.enter.prevent="sendMessage()" placeholder="Ask anything..."></textarea>

      <button class="ai-chat-send" @click="sendMessage()" 
        :disabled="loading || !question.trim()">

        <span x-show="!loading" class="ai-send-icon"></span>
        <span x-show="loading" class="ai-spinner"></span>
      </button>
    </div>
  </div>
</div>

<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script>
function aiChat(currentProductId = 0) {
  return {
    question: "",
    loading: false,
    productId: currentProductId,
    hasWelcomed: true,
    
    chatOpen: false, 

    messages: [
      { type: 'ai', content: "ðŸ‘‹ Hello! I am your AI assistant. How can I help you today?" }
    ],

    toggleChat() {
      this.chatOpen = !this.chatOpen;

      if (this.chatOpen) {
        this.$nextTick(() => {
            this.$refs.messagesContainer.scrollTop = this.$refs.messagesContainer.scrollHeight;
        });
      }
    },

    async sendMessage(){
      if (!this.question.trim() || this.loading) return;

      const q = this.question.trim();
      this.question = "";

      this.messages.push({ type: "user", content: q });

      this.messages.push({ type: "loading", content: '<div class="ai-spinner"></div>' });
      this.loading = true;

      this.$nextTick(() => {
        this.$refs.messagesContainer.scrollTop = this.$refs.messagesContainer.scrollHeight;
      });

      const endpoint = "http://192.168.0.147/hyvamagento/pub/rest/V1/aiassistance/ask"; 

      try {
        const payload = { 
            question: q,
            productId: this.productId > 0 ? this.productId : null
        };
        
        const res = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const raw = await res.text();
        this.messages.pop();

        let data;
        try {
          data = JSON.parse(raw);
        } catch {
          this.messages.push({ type: "ai", content: raw });
          return;
        }

        if (Array.isArray(data)) {
          const success = data[0];
          let msg = data[1] || "No response.";

          if (success) {
            this.messages.push({ type: "ai", content: msg.replace(/\n/g, "<br>") });
          } else {
            this.messages.push({ type: "error", content: msg });
          }
          return;
        }

        if (data.success) {
          const msg = data.message;
          this.messages.push({ type: "ai", content: msg.replace(/\n/g, "<br>") });
        } else {
          this.messages.push({ type: "error", content: data.message });
        }

      } catch (e) {
        this.messages.pop();
        this.messages.push({ type: "error", content: "Network Error: " + e.message });
      } finally {
        this.loading = false;
        this.$nextTick(() => {
          this.$refs.messagesContainer.scrollTop = this.$refs.messagesContainer.scrollHeight;
        });
      }
    }
  }
}
</script>